<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Exercises - FluentForm</title>
    <link rel="stylesheet" href="./styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
</head>
<body data-auto-init="true" data-active-page="practice">
    <!-- Accessibility skip link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="page-wrapper">
        <!-- Header will be injected by components.js -->
        
        <main id="main-content" class="main-content">
            <div class="container">
                <section class="welcome-section fade-in">
                    <h1>Practice Exercises</h1>
                    <p class="subtitle">Improve your pronunciation with targeted exercises</p>
                </section>

                <!-- Exercise Selection Interface -->
                <div id="exerciseSelection" class="practice-dashboard">
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="bi bi-list-check"></i> Exercise Library</h2>
                            <div class="view-toggle">
                                <button id="focusedBtn" class="btn btn-small btn-primary active">
                                    <i class="bi bi-star-fill"></i> Recommended
                                </button>
                                <button id="allExercisesBtn" class="btn btn-small btn-secondary">
                                    <i class="bi bi-grid"></i> All Exercises
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-content">
                            <!-- Filters Section -->
                            <div class="filters-section">
                                <div class="filter-group">
                                    <label for="phonemeFilter">Phoneme Focus:</label>
                                    <select id="phonemeFilter" class="filter-select">
                                        <option value="">All Phonemes</option>
                                        <option value="r">R Sound</option>
                                        <option value="s">S Sound</option>
                                        <option value="th">TH Sound</option>
                                        <option value="l">L Sound</option>
                                        <option value="sh">SH Sound</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label for="difficultyFilter">Difficulty:</label>
                                    <select id="difficultyFilter" class="filter-select">
                                        <option value="">All Levels</option>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label for="typeFilter">Exercise Type:</label>
                                    <select id="typeFilter" class="filter-select">
                                        <option value="">All Types</option>
                                        <option value="tongue-twister">Tongue Twisters</option>
                                        <option value="minimal-pairs">Minimal Pairs</option>
                                        <option value="sentence">Sentences</option>
                                        <option value="word-list">Word Lists</option>
                                    </select>
                                </div>
                                
                                <button id="clearFilters" class="btn btn-small btn-secondary">
                                    <i class="bi bi-x-circle"></i> Clear Filters
                                </button>
                            </div>
                            
                            <!-- Focus Areas (shown in recommended view) -->
                            <div id="focusAreaSection" class="focus-areas-section">
                                <h3><i class="bi bi-bullseye"></i> Your Focus Areas</h3>
                                <p class="focus-description">Based on your proficiency test, these are the sounds you should focus on:</p>
                                
                                <div id="focusPhonemes" class="focus-phonemes">
                                    <!-- This will be populated from test results -->
                                    <div class="empty-state">
                                        <i class="bi bi-info-circle"></i>
                                        <p>Complete a proficiency test to see your focus areas</p>
                                        <a href="proficiency.html" class="btn btn-primary">Take Proficiency Test</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Exercise Grid -->
                            <div id="exercisesGrid" class="exercises-grid">
                                <!-- Exercise cards will be generated here -->
                                <div class="loading">
                                    <i class="bi bi-arrow-repeat"></i>
                                    <p>Loading exercises...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exercise Interface (hidden initially) -->
                <div id="exerciseInterface" class="exercise-interface" style="display: none;">
                    <div class="exercise-nav">
                        <button id="backToExercises" class="btn btn-secondary">
                            <i class="bi bi-arrow-left btn-icon"></i> Back to Exercises
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 id="exerciseTitle">Exercise Title</h2>
                            <div class="exercise-progress">
                                <span id="progressText">Prompt 1 of 5</span>
                                <div class="progress-container">
                                    <div id="exerciseProgressBar" class="progress-bar progress-bar-primary" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-content">
                            <div class="exercise-main">
                                <div class="exercise-prompt-section">
                                    <h3>Say this aloud:</h3>
                                    <div id="promptText" class="exercise-prompt">
                                        Loading prompt...
                                    </div>
                                    
                                    <div class="hint-section">
                                        <button id="showHintBtn" class="btn btn-small btn-secondary">
                                            <i class="bi bi-lightbulb"></i> Show Pronunciation Hint
                                        </button>
                                        <div id="hintContent" class="hint-content" style="display: none;">
                                            <h4>Pronunciation Tips:</h4>
                                            <p id="phonemeTips">Tips will appear here.</p>
                                            <button id="showModelBtn" class="btn btn-small btn-primary">
                                                <i class="bi bi-box"></i> Show 3D Model
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="recording-section">
                                    <div class="exercise-controls">
                                        <button id="recordButton" class="btn btn-accent btn-large">
                                            <i class="bi bi-record-circle btn-icon"></i> Start Recording
                                        </button>
                                        <button id="playButton" class="btn btn-secondary btn-large" disabled>
                                            <i class="bi bi-play-fill btn-icon"></i> Play Recording
                                        </button>
                                    </div>
                                    
                                    <p class="status" id="status">Click to start recording</p>
                                    <audio id="audioPlayback" class="audio-player" controls style="display: none;"></audio>
                                </div>
                            </div>
                            
                            <div class="analysis-section" style="display: none;" id="analysisSection">
                                <h3><i class="bi bi-chat-text"></i> Your Speech</h3>
                                <div id="transcription" class="transcription-display">
                                    Your transcription will appear here...
                                </div>
                                
                                <div id="feedbackContainer">
                                    <h3><i class="bi bi-graph-up"></i> Analysis</h3>
                                    <div id="feedback" class="feedback-display">
                                        Analysis will appear here...
                                    </div>
                                </div>
                                
                                <div class="exercise-actions">
                                    <button id="tryAgainBtn" class="btn btn-secondary">
                                        <i class="bi bi-arrow-repeat btn-icon"></i> Try Again
                                    </button>
                                    <button id="nextPromptBtn" class="btn btn-primary">
                                        <i class="bi bi-arrow-right btn-icon"></i> Next
                                    </button>
                                </div>
                            </div>
                            
                            <div id="exerciseComplete" class="exercise-complete" style="display: none;">
                                <div class="complete-icon">
                                    <i class="bi bi-trophy-fill"></i>
                                </div>
                                <h3>Exercise Complete!</h3>
                                <div class="complete-stats">
                                    <div class="stat-card">
                                        <div class="stat-value" id="totalPromptsValue">0</div>
                                        <div class="stat-label">Prompts Completed</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="avgScoreValue">0%</div>
                                        <div class="stat-label">Average Score</div>
                                    </div>
                                </div>
                                
                                <div class="complete-actions">
                                    <button id="restartExerciseBtn" class="btn btn-secondary">
                                        <i class="bi bi-arrow-repeat btn-icon"></i> Restart Exercise
                                    </button>
                                    <button id="backToLibraryBtn" class="btn btn-primary">
                                        <i class="bi bi-grid btn-icon"></i> Back to Library
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 3D model container for visualization -->
    <div id="mouthModelContainer" class="model-container-fixed">
        <button id="closeModelBtn" class="close-model-btn">
            <i class="bi bi-x-lg"></i>
        </button>
        <div id="modelContent" style="height: 100%; width: 100%"></div>
    </div>

    <!-- Load components and utilities -->
    <script src="./js/components.js"></script>
    <script src="./js/charts.js"></script>
    <script src="./js/3dmodel.js"></script>
    <script src="./js/ui-components.js"></script>
    
    <!-- Exercise data and initialization script (placeholder) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mouth model
            const mouthModel = new FluentForm.MouthModel('modelContent');
            window.mouthModel = mouthModel; // Make it globally available
            
            // Close model button event
            document.getElementById('closeModelBtn').addEventListener('click', () => {
                document.getElementById('mouthModelContainer').style.display = 'none';
            });
            
            // Toggle between recommended and all exercises views
            document.getElementById('focusedBtn').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('allExercisesBtn').classList.remove('active');
                document.getElementById('focusAreaSection').style.display = 'block';
                loadRecommendedExercises();
            });
            
            document.getElementById('allExercisesBtn').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('focusedBtn').classList.remove('active');
                document.getElementById('focusAreaSection').style.display = 'none';
                loadAllExercises();
            });
            
            // Clear filters button
            document.getElementById('clearFilters').addEventListener('click', function() {
                document.getElementById('phonemeFilter').value = '';
                document.getElementById('difficultyFilter').value = '';
                document.getElementById('typeFilter').value = '';
                
                if (document.getElementById('focusedBtn').classList.contains('active')) {
                    loadRecommendedExercises();
                } else {
                    loadAllExercises();
                }
            });
            
            // Filter change events
            const filters = document.querySelectorAll('.filter-select');
            filters.forEach(filter => {
                filter.addEventListener('change', function() {
                    if (document.getElementById('focusedBtn').classList.contains('active')) {
                        loadRecommendedExercises();
                    } else {
                        loadAllExercises();
                    }
                });
            });
            
            // Check for focus phonemes from proficiency test
            loadFocusPhonemes();
            
            // Load initial exercises
            loadRecommendedExercises();
        });
        
        // Load focus phonemes from localStorage (set by proficiency test)
        function loadFocusPhonemes() {
            const focusPhonemesSection = document.getElementById('focusPhonemes');
            const problemSounds = localStorage.getItem('problemSounds');
            
            if (problemSounds) {
                try {
                    const phonemes = JSON.parse(problemSounds);
                    
                    if (phonemes && phonemes.length > 0) {
                        let html = '<div class="focus-phonemes-list">';
                        
                        phonemes.forEach(p => {
                            const scoreClass = getScoreClass(p.score);
                            
                            html += `
                                <div class="focus-phoneme-item">
                                    <div class="focus-phoneme">
                                        <span class="phoneme-symbol">${p.phoneme}</span>
                                        <div class="focus-phoneme-details">
                                            <span class="phoneme-score ${scoreClass}">${p.score}%</span>
                                        </div>
                                        <button class="btn btn-small btn-secondary show-model-btn" data-phoneme="${p.phoneme}">
                                            <i class="bi bi-box"></i> Show Position
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        focusPhonemesSection.innerHTML = html;
                        
                        // Add event listeners for show model buttons
                        document.querySelectorAll('.show-model-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const phoneme = btn.getAttribute('data-phoneme');
                                document.getElementById('mouthModelContainer').style.display = 'flex';
                                window.mouthModel.showPhonemePosition(phoneme);
                            });
                        });
                        
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing problem sounds:', e);
                }
            }
            
            // Show empty state if no data
            focusPhonemesSection.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-info-circle"></i>
                    <p>Complete a proficiency test to see your focus areas</p>
                    <a href="proficiency.html" class="btn btn-primary">Take Proficiency Test</a>
                </div>
            `;
        }
        
        // Helper function to get score class
        function getScoreClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 75) return 'good';
            if (score >= 60) return 'average';
            if (score >= 40) return 'needs-work';
            return 'poor';
        }
        
        // Load recommended exercises based on proficiency test results
        function loadRecommendedExercises() {
            const exercisesGrid = document.getElementById('exercisesGrid');
            exercisesGrid.innerHTML = '<div class="loading"><i class="bi bi-arrow-repeat"></i><p>Loading exercises...</p></div>';
            
            // Get filter values
            const phonemeFilter = document.getElementById('phonemeFilter').value;
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            // Get problem phonemes from localStorage
            let problemPhonemes = [];
            try {
                const problemSounds = localStorage.getItem('problemSounds');
                if (problemSounds) {
                    problemPhonemes = JSON.parse(problemSounds).map(p => p.phoneme);
                }
            } catch (e) {
                console.error('Error loading problem phonemes:', e);
            }
            
            // Simulate loading exercises (in a real app, this would be an API call)
            setTimeout(() => {
                let html = '';
                
                // Filter exercises based on the problem phonemes and other filters
                const exercises = getExercises().filter(exercise => {
                    // If no problem phonemes, show beginner exercises
                    if (problemPhonemes.length === 0 && exercise.difficulty === 'beginner') {
                        return true;
                    }
                    
                    // If there are problem phonemes, filter by them
                    if (problemPhonemes.length > 0 && problemPhonemes.includes(exercise.phoneme)) {
                        // Apply additional filters if specified
                        if (phonemeFilter && exercise.phoneme !== phonemeFilter) return false;
                        if (difficultyFilter && exercise.difficulty !== difficultyFilter) return false;
                        if (typeFilter && exercise.type !== typeFilter) return false;
                        return true;
                    }
                    
                    return false;
                });
                
                if (exercises.length === 0) {
                    html = `
                        <div class="empty-state">
                            <i class="bi bi-emoji-neutral"></i>
                            <p>No exercises match your filters</p>
                            <button id="resetFiltersBtn" class="btn btn-primary">Reset Filters</button>
                        </div>
                    `;
                } else {
                    exercises.forEach(exercise => {
                        html += createExerciseCard(exercise);
                    });
                }
                
                exercisesGrid.innerHTML = html;
                
                // Add event listeners to reset filters button if present
                const resetBtn = document.getElementById('resetFiltersBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        document.getElementById('phonemeFilter').value = '';
                        document.getElementById('difficultyFilter').value = '';
                        document.getElementById('typeFilter').value = '';
                        loadRecommendedExercises();
                    });
                }
                
                // Add event listeners to exercise cards
                addExerciseCardListeners();
            }, 500);
        }
        
        // Load all exercises
        function loadAllExercises() {
            const exercisesGrid = document.getElementById('exercisesGrid');
            exercisesGrid.innerHTML = '<div class="loading"><i class="bi bi-arrow-repeat"></i><p>Loading exercises...</p></div>';
            
            // Get filter values
            const phonemeFilter = document.getElementById('phonemeFilter').value;
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            // Simulate loading exercises (in a real app, this would be an API call)
            setTimeout(() => {
                // Filter exercises based on the selected filters
                const exercises = getExercises().filter(exercise => {
                    if (phonemeFilter && exercise.phoneme !== phonemeFilter) return false;
                    if (difficultyFilter && exercise.difficulty !== difficultyFilter) return false;
                    if (typeFilter && exercise.type !== typeFilter) return false;
                    return true;
                });
                
                let html = '';
                
                if (exercises.length === 0) {
                    html = `
                        <div class="empty-state">
                            <i class="bi bi-emoji-neutral"></i>
                            <p>No exercises match your filters</p>
                            <button id="resetFiltersBtn" class="btn btn-primary">Reset Filters</button>
                        </div>
                    `;
                } else {
                    exercises.forEach(exercise => {
                        html += createExerciseCard(exercise);
                    });
                }
                
                exercisesGrid.innerHTML = html;
                
                // Add event listeners to reset filters button if present
                const resetBtn = document.getElementById('resetFiltersBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        document.getElementById('phonemeFilter').value = '';
                        document.getElementById('difficultyFilter').value = '';
                        document.getElementById('typeFilter').value = '';
                        loadAllExercises();
                    });
                }
                
                // Add event listeners to exercise cards
                addExerciseCardListeners();
            }, 500);
        }
        
        // Add event listeners to exercise cards
        function addExerciseCardListeners() {
            document.querySelectorAll('.exercise-card').forEach(card => {
                card.addEventListener('click', () => {
                    const exerciseId = card.getAttribute('data-id');
                    startExercise(exerciseId);
                });
            });
        }
        
        // Create HTML for an exercise card
        function createExerciseCard(exercise) {
            return `
                <div class="exercise-card card" data-id="${exercise.id}">
                    <div class="exercise-header">
                        <h3 class="exercise-title">${exercise.title}</h3>
                        <div class="exercise-meta">
                            <span class="exercise-level ${exercise.difficulty}">${exercise.difficulty}</span>
                            <span class="exercise-phoneme">Focus: "${exercise.phoneme}"</span>
                        </div>
                    </div>
                    <div class="exercise-content">
                        <p>${exercise.description}</p>
                        <div class="exercise-footer">
                            <button class="btn btn-primary">
                                <i class="bi bi-play-fill btn-icon"></i>
                                Start Exercise
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Start an exercise
        function startExercise(exerciseId) {
            // Find the exercise by ID
            const exercise = getExercises().find(ex => ex.id === exerciseId);
            
            if (!exercise) {
                console.error('Exercise not found:', exerciseId);
                return;
            }
            
            // Hide exercise selection, show exercise interface
            document.getElementById('exerciseSelection').style.display = 'none';
            document.getElementById('exerciseInterface').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('exerciseComplete').style.display = 'none';
            
            // Update exercise title
            document.getElementById('exerciseTitle').textContent = exercise.title;
            
            // Set up exercise data
            window.currentExercise = {
                exercise: exercise,
                currentPromptIndex: 0,
                results: []
            };
            
            // Update progress indicators
            updateExerciseProgress();
            
            // Set up the first prompt
            showCurrentPrompt();
            
            // Set up event listeners
            setupExerciseEventListeners();
        }
        
        // Update progress indicators
        function updateExerciseProgress() {
            const { currentPromptIndex, exercise } = window.currentExercise;
            const totalPrompts = exercise.prompts.length;
            const progressPercent = ((currentPromptIndex) / totalPrompts) * 100;
            
            document.getElementById('progressText').textContent = `Prompt ${currentPromptIndex + 1} of ${totalPrompts}`;
            document.getElementById('exerciseProgressBar').style.width = `${progressPercent}%`;
        }
        
        // Show current prompt
        function showCurrentPrompt() {
            const { currentPromptIndex, exercise } = window.currentExercise;
            const promptText = exercise.prompts[currentPromptIndex];
            
            document.getElementById('promptText').textContent = promptText;
            
            // Update hint content
            const phonemeInfo = FluentForm.UI.getPhonemeInfo(exercise.phoneme);
            document.getElementById('phonemeTips').textContent = phonemeInfo.pronunciation;
            
            // Reset recording UI
            resetRecordingUI();
        }
        
        // Set up event listeners for exercise interface
        function setupExerciseEventListeners() {
            // Back button
            document.getElementById('backToExercises').addEventListener('click', () => {
                document.getElementById('exerciseInterface').style.display = 'none';
                document.getElementById('exerciseSelection').style.display = 'block';
            });
            
            // Show/hide hint
            document.getElementById('showHintBtn').addEventListener('click', () => {
                const hintContent = document.getElementById('hintContent');
                if (hintContent.style.display === 'none') {
                    hintContent.style.display = 'block';
                    document.getElementById('showHintBtn').innerHTML = '<i class="bi bi-lightbulb-fill"></i> Hide Pronunciation Hint';
                } else {
                    hintContent.style.display = 'none';
                    document.getElementById('showHintBtn').innerHTML = '<i class="bi bi-lightbulb"></i> Show Pronunciation Hint';
                }
            });
            
            // Show 3D model
            document.getElementById('showModelBtn').addEventListener('click', () => {
                const phoneme = window.currentExercise.exercise.phoneme;
                document.getElementById('mouthModelContainer').style.display = 'flex';
                window.mouthModel.showPhonemePosition(phoneme);
            });
            
            // Try again button
            document.getElementById('tryAgainBtn').addEventListener('click', () => {
                document.getElementById('analysisSection').style.display = 'none';
                resetRecordingUI();
            });
            
            // Next prompt button
            document.getElementById('nextPromptBtn').addEventListener('click', () => {
                nextPrompt();
            });
            
            // Exercise complete buttons
            document.getElementById('restartExerciseBtn').addEventListener('click', () => {
                window.currentExercise.currentPromptIndex = 0;
                window.currentExercise.results = [];
                updateExerciseProgress();
                showCurrentPrompt();
                document.getElementById('exerciseComplete').style.display = 'none';
            });
            
            document.getElementById('backToLibraryBtn').addEventListener('click', () => {
                document.getElementById('exerciseInterface').style.display = 'none';
                document.getElementById('exerciseSelection').style.display = 'block';
            });
            
            // Set up recording functionality
            setupRecording();
        }
        
        // Reset recording UI
        function resetRecordingUI() {
            const recordButton = document.getElementById('recordButton');
            const playButton = document.getElementById('playButton');
            const status = document.getElementById('status');
            const audioPlayback = document.getElementById('audioPlayback');
            
            recordButton.innerHTML = '<i class="bi bi-record-circle btn-icon"></i> Start Recording';
            recordButton.classList.remove('btn-error');
            recordButton.classList.add('btn-accent');
            playButton.disabled = true;
            status.textContent = 'Click to start recording';
            audioPlayback.style.display = 'none';
        }
        
        // Move to next prompt
        function nextPrompt() {
            const { currentPromptIndex, exercise } = window.currentExercise;
            
            // Check if this was the last prompt
            if (currentPromptIndex >= exercise.prompts.length - 1) {
                showExerciseComplete();
                return;
            }
            
            // Move to next prompt
            window.currentExercise.currentPromptIndex++;
            updateExerciseProgress();
            showCurrentPrompt();
            document.getElementById('analysisSection').style.display = 'none';
        }
        
        // Show exercise complete screen
        function showExerciseComplete() {
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('exerciseComplete').style.display = 'block';
            
            // Calculate stats
            const results = window.currentExercise.results;
            const totalPrompts = window.currentExercise.exercise.prompts.length;
            
            document.getElementById('totalPromptsValue').textContent = totalPrompts;
            
            if (results.length > 0) {
                // Calculate average score from all phoneme scores across all prompts
                const allScores = results.flatMap(r => r.phonemes?.map(p => p.accuracyScore) || []);
                
                if (allScores.length > 0) {
                    const avgScore = Math.round(allScores.reduce((sum, score) => sum + score, 0) / allScores.length);
                    document.getElementById('avgScoreValue').textContent = `${avgScore}%`;
                    
                    // Style based on score
                    const statValue = document.getElementById('avgScoreValue');
                    if (avgScore >= 90) {
                        statValue.style.color = 'var(--score-excellent)';
                    } else if (avgScore >= 75) {
                        statValue.style.color = 'var(--score-good)';
                    } else if (avgScore >= 60) {
                        statValue.style.color = 'var(--score-average)';
                    } else {
                        statValue.style.color = 'var(--score-needs-work)';
                    }
                }
            }
        }
        
        // Set up recording functionality
        function setupRecording() {
            let mediaRecorder;
            let audioChunks = [];
            let audioUrl;
            
            const recordButton = document.getElementById('recordButton');
            const playButton = document.getElementById('playButton');
            const status = document.getElementById('status');
            const audioPlayback = document.getElementById('audioPlayback');
            
            recordButton.addEventListener('click', async () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recordButton.innerHTML = '<i class="bi bi-record-circle btn-icon"></i> Start Recording';
                    recordButton.classList.remove('btn-error');
                    recordButton.classList.add('btn-accent');
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                channelCount: 1,
                                sampleRate: 16000
                            }
                        });
                        
                        audioChunks = [];
                        
                        mediaRecorder = new MediaRecorder(stream, {
                            mimeType: 'audio/webm'
                        });
                        
                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };
                        
                        mediaRecorder.onstop = () => {
                            // Create the WebM blob
                            const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            
                            // Create URL for playback
                            if (audioUrl) {
                                URL.revokeObjectURL(audioUrl);
                            }
                            audioUrl = URL.createObjectURL(webmBlob);
                            
                            // Set up audio playback
                            audioPlayback.src = audioUrl;
                            audioPlayback.style.display = 'block';
                            playButton.disabled = false;
                            
                            // Convert WebM to WAV and analyze
                            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            const fileReader = new FileReader();
                            
                            fileReader.onloadend = () => {
                                const arrayBuffer = fileReader.result;
                                audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
                                    // Convert to WAV
                                    const wavBuffer = audioBufferToWav(audioBuffer);
                                    const wavBlob = new Blob([wavBuffer], { type: 'audio/wav' });
                                    
                                    // Show analysis section with loading indicators
                                    document.getElementById('analysisSection').style.display = 'block';
                                    document.getElementById('transcription').innerHTML = 
                                        '<div class="loading"><i class="bi bi-arrow-repeat"></i> Processing your speech...</div>';
                                    document.getElementById('feedback').innerHTML = 
                                        '<div class="loading"><i class="bi bi-arrow-repeat"></i> Analyzing your pronunciation...</div>';
                                    
                                    // Send to server with reference text
                                    const formData = new FormData();
                                    formData.append('audio', wavBlob, 'recording.wav');
                                    
                                    // Get current prompt as reference text
                                    const { currentPromptIndex, exercise } = window.currentExercise;
                                    const referenceText = exercise.prompts[currentPromptIndex];
                                    
                                    formData.append('referenceText', referenceText);
                                    
                                    fetch('http://127.0.0.1:3000/api/analyze-speech', {
                                        method: 'POST',
                                        body: formData
                                    })
                                    .then(response => response.json())
                                    .then(results => {
                                        // Save results for later statistics
                                        window.currentExercise.results.push(results);
                                        
                                        // Update UI with the results
                                        FluentForm.UI.createVisualTranscription('transcription', results.transcription, results.phonemes);
                                        FluentForm.UI.initVisualTranscriptionInteractions();
                                        
                                        // Create phoneme analysis display
                                        const phonemeGridHtml = FluentForm.UI.createPhonemeGrid(results.phonemes);
                                        document.getElementById('feedback').innerHTML = phonemeGridHtml;
                                        
                                        // Update the 3D model for the selected phoneme
                                        if (window.mouthModel) {
                                            window.mouthModel.showPhonemePosition(window.currentExercise.exercise.phoneme);
                                        }
                                        
                                        status.textContent = 'Analysis complete';
                                    })
                                    .catch(error => {
                                        console.error('Analysis error:', error);
                                        document.getElementById('transcription').innerHTML = `
                                            <div class="error-state">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <p>There was an error processing your speech.</p>
                                                <p>Please try again later.</p>
                                            </div>
                                        `;
                                        document.getElementById('feedback').innerHTML = `
                                            <div class="error-state">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <p>Error: ${error.message}</p>
                                            </div>
                                        `;
                                        status.textContent = 'Error: ' + error.message;
                                    });
                                });
                            };
                            
                            fileReader.readAsArrayBuffer(webmBlob);
                        };
                        
                        mediaRecorder.start(100);
                        recordButton.innerHTML = '<i class="bi bi-stop-fill btn-icon"></i> Stop Recording';
                        recordButton.classList.remove('btn-accent');
                        recordButton.classList.add('btn-error');
                        status.textContent = 'Recording...';
                        
                    } catch (error) {
                        console.error('Recording error:', error);
                        status.textContent = 'Error: ' + error.message;
                    }
                }
            });
            
            playButton.addEventListener('click', () => {
                if (audioPlayback.paused) {
                    audioPlayback.play();
                    playButton.innerHTML = '<i class="bi bi-pause-fill btn-icon"></i> Pause';
                } else {
                    audioPlayback.pause();
                    playButton.innerHTML = '<i class="bi bi-play-fill btn-icon"></i> Play Recording';
                }
            });
            
            audioPlayback.addEventListener('ended', () => {
                playButton.innerHTML = '<i class="bi bi-play-fill btn-icon"></i> Play Recording';
            });
        }
        
        // Helper function to convert AudioBuffer to WAV format
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const wav = new ArrayBuffer(44 + buffer.length * bytesPerSample);
            const view = new DataView(wav);
            
            // Write WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + buffer.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, buffer.length * bytesPerSample, true);
            
            // Write audio data
            const offset = 44;
            const data = new Float32Array(buffer.length);
            buffer.copyFromChannel(data, 0);
            
            for (let i = 0; i < data.length; i++) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset + i * bytesPerSample, sample * 0x7FFF, true);
            }
            
            return wav;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
    </script>
    
    <style>
        /* Specific styles for practice page */
        .filters-section {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            align-items: flex-end;
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background-color: var(--background-light);
            border-radius: var(--border-radius-medium);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-group label {
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }
        
        .filter-select {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--neutral-light);
            border-radius: var(--border-radius-small);
            background-color: var(--neutral-white);
            font-family: inherit;
        }
        
        .exercises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-top: var(--space-lg);
        }
        
        .exercise-card {
            cursor: pointer;
            transition: all var(--transition-normal);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-large);
        }
        
        .exercise-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .exercise-footer {
            margin-top: auto;
            padding-top: var(--space-md);
        }
        
        .exercise-meta {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-top: var(--space-xs);
        }
        
        .exercise-level {
            display: inline-block;
            padding: var(--space-xxs) var(--space-xs);
            border-radius: var(--border-radius-small);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .exercise-level.beginner {
            background-color: var(--success-color-light);
            color: var(--success-color);
        }
        
        .exercise-level.intermediate {
            background-color: var(--info-color-light);
            color: var(--info-color);
        }
        
        .exercise-level.advanced {
            background-color: var(--warning-color-light);
            color: var(--warning-color);
        }
        
        .exercise-phoneme {
            font-size: var(--font-size-sm);
            color: var(--neutral-light);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .view-toggle {
            display: flex;
            gap: var(--space-xs);
        }
        
        .focus-areas-section {
            margin: var(--space-lg) 0;
            padding: var(--space-md);
            background-color: var(--fluent-primary-light);
            color: white;
            border-radius: var(--border-radius-medium);
        }
        
        .focus-areas-section h3 {
            color: white;
            margin-top: 0;
        }
        
        .focus-description {
            margin-bottom: var(--space-md);
        }
        
        .focus-phonemes {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-top: var(--space-md);
        }
        
        .focus-phonemes-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            width: 100%;
        }
        
        .focus-phoneme-item {
            flex: 1;
            min-width: 200px;
        }
        
        .focus-phoneme {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius-medium);
            padding: var(--space-sm);
            color: var(--neutral-dark);
        }
        
        .focus-phoneme .phoneme-symbol {
            font-size: 1.2rem;
            font-weight: 700;
            background-color: var(--fluent-primary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-sm);
        }
        
        .focus-phoneme-details {
            flex: 1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .view-toggle {
                margin-top: var(--space-sm);
            }
            
            .exercises-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .filters-section {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-sm);
            }
            
            .focus-phoneme {
                flex-direction: column;
                text-align: center;
                padding: var(--space-md);
            }
            
            .focus-phoneme .phoneme-symbol {
                margin: 0 auto var(--space-sm);
            }
            
            .show-model-btn {
                margin-top: var(--space-sm);
            }
        }
        
        /* Exercise interface styles */
        .exercise-nav {
            margin-bottom: var(--space-md);
        }
        
        .exercise-progress {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        #progressText {
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-xs);
            color: var(--neutral-light);
        }
        
        .exercise-main {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }
        
        .exercise-prompt-section {
            flex: 1;
            min-width: 300px;
        }
        
        .recording-section {
            flex: 1;
            min-width: 300px;
        }
        
        .exercise-controls {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .exercise-prompt {
            background-color: var(--background-light);
            padding: var(--space-lg);
            border-radius: var(--border-radius-medium);
            font-size: var(--font-size-lg);
            font-weight: 500;
            margin-bottom: var(--space-lg);
            line-height: 1.6;
            color: var(--neutral-dark);
            box-shadow: var(--shadow-small);
        }
        
        .hint-section {
            margin-top: var(--space-lg);
        }
        
        .hint-content {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background-color: var(--info-color-light);
            border-radius: var(--border-radius-medium);
            color: var(--neutral-dark);
        }
        
        .hint-content h4 {
            margin-top: 0;
            color: var(--fluent-primary);
        }
        
        .exercise-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
            margin-top: var(--space-xl);
        }
        
        .status {
            color: var(--neutral-light);
            margin: var(--space-xs) 0 var(--space-md);
        }
        
        .audio-player {
            width: 100%;
            margin-bottom: var(--space-md);
        }
        
        /* Exercise complete styles */
        .exercise-complete {
            text-align: center;
            padding: var(--space-xl) var(--space-md);
        }
        
        .complete-icon {
            font-size: 4rem;
            color: var(--fluent-accent);
            margin-bottom: var(--space-md);
        }
        
        .complete-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin: var(--space-xl) 0;
        }
        
        .stat-card {
            background-color: var(--background-light);
            padding: var(--space-lg);
            border-radius: var(--border-radius-medium);
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--fluent-primary);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--neutral-light);
            margin-top: var(--space-xs);
        }
        
        .complete-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            margin-top: var(--space-xl);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .exercise-main {
                flex-direction: column;
                gap: var(--space-lg);
            }
            
            .exercise-prompt-section,
            .recording-section {
                width: 100%;
            }
            
            .complete-stats {
                flex-direction: column;
                gap: var(--space-md);
                align-items: center;
            }
            
            .stat-card {
                width: 80%;
            }
        }
    </style>
</body>
</html>
