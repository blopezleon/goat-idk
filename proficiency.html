<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proficiency Test - FluentForm</title>
    <link rel="stylesheet" href="./styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
</head>
<body data-auto-init="true" data-active-page="proficiency">
    <!-- Accessibility skip link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="page-wrapper">
        <!-- Header will be injected by components.js -->
        
        <main id="main-content" class="main-content">
            <div class="container">
                <section class="welcome-section fade-in">
                    <h1>Speech Proficiency Test</h1>
                    <p class="subtitle">Let's evaluate your speech to identify areas for improvement</p>
                </section>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="bi bi-mic-fill"></i> Proficiency Assessment</h2>
                    </div>
                    
                    <div class="card-content">
                        <div id="instructions" class="instructions-panel">
                            <h3><i class="bi bi-info-circle"></i> Instructions</h3>
                            <p>This assessment will help identify which speech sounds you might have difficulty with. Follow these steps:</p>
                            
                            <div class="steps-container">
                                <div class="step">
                                    <div class="step-number">1</div>
                                    <div class="step-content">
                                        <h4>Read aloud each prompt</h4>
                                        <p>You'll be shown a series of sentences designed to test different speech sounds.</p>
                                    </div>
                                </div>
                                <div class="step">
                                    <div class="step-number">2</div>
                                    <div class="step-content">
                                        <h4>Record your speech</h4>
                                        <p>Use the recording button to capture your pronunciation.</p>
                                    </div>
                                </div>
                                <div class="step">
                                    <div class="step-number">3</div>
                                    <div class="step-content">
                                        <h4>Review your results</h4>
                                        <p>After each recording, you'll get feedback on your pronunciation.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="startTestBtn" class="btn btn-primary btn-large">
                                <i class="bi bi-play-fill btn-icon"></i> Start Assessment
                            </button>
                        </div>

                        <div id="testInterface" style="display: none;">
                            <div class="progress-indicator">
                                <div class="progress-label">Progress</div>
                                <div class="progress-container">
                                    <div id="progressBar" class="progress-bar progress-bar-primary" style="width: 0%"></div>
                                </div>
                                <div id="progressText">Prompt 1 of 5</div>
                            </div>

                            <div class="exercise-section">
                                <h3>Please read this sentence aloud:</h3>
                                <div id="promptDisplay" class="exercise-prompt">
                                    Loading prompts...
                                </div>
                                
                                <div class="exercise-controls">
                                    <button id="recordButton" class="btn btn-accent">
                                        <i class="bi bi-record-circle btn-icon"></i> Start Recording
                                    </button>
                                    <button id="playButton" class="btn btn-secondary" disabled>
                                        <i class="bi bi-play-fill btn-icon"></i> Play Recording
                                    </button>
                                    <button id="nextButton" class="btn btn-primary" disabled>
                                        <i class="bi bi-arrow-right btn-icon"></i> Next
                                    </button>
                                </div>
                                
                                <p class="status" id="status">Click to start recording</p>
                                
                                <audio id="audioPlayback" class="audio-player" controls style="display: none;"></audio>
                            </div>
                            
                            <div class="analysis-section">
                                <h3><i class="bi bi-chat-text"></i> Your Speech</h3>
                                <div id="transcription" class="transcription-display">Transcription will appear here...</div>
                                
                                <h3><i class="bi bi-graph-up"></i> Analysis</h3>
                                <div id="analysis" class="analysis-display">Analysis will appear here...</div>
                            </div>
                        </div>

                        <div id="resultsSummary" style="display: none;">
                            <h3><i class="bi bi-clipboard-check"></i> Assessment Complete</h3>
                            
                            <div class="summary-card">
                                <div class="summary-header">
                                    <h4>Your Speech Profile</h4>
                                </div>
                                <div class="summary-content">
                                    <div id="overallScoreContainer" class="overall-score-container">
                                        <div class="score-circle">
                                            <span id="overallScore">--</span>
                                            <span class="percent">%</span>
                                        </div>
                                        <div class="score-label">Overall Score</div>
                                    </div>
                                    
                                    <h4>Phoneme Proficiency</h4>
                                    <div id="phonemeGrid" class="phoneme-grid">
                                        <!-- Phoneme cards will be inserted here -->
                                    </div>
                                    
                                    <h4>Focus Areas for Improvement</h4>
                                    <div id="focusAreas" class="focus-areas">
                                        <!-- Focus areas will be inserted here -->
                                    </div>
                                    
                                    <div id="recommendationsContainer" class="recommendations-container">
                                        <h4>Recommendations</h4>
                                        <p id="recommendationsText"></p>
                                        
                                        <div class="recommended-exercises">
                                            <h5>Recommended Exercises</h5>
                                            <div id="exerciseRecommendations" class="recommendations-grid">
                                                <!-- Exercise cards will be inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="summary-footer">
                                    <a href="practice.html" class="btn btn-primary">
                                        <i class="bi bi-mic-fill btn-icon"></i> Start Practicing
                                    </a>
                                    <a href="index.html" class="btn btn-secondary">
                                        <i class="bi bi-house-fill btn-icon"></i> Back to Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 3D model container for visualization -->
    <div id="mouthModelContainer" class="model-container-fixed">
        <button id="closeModelBtn" class="close-model-btn">
            <i class="bi bi-x-lg"></i>
        </button>
        <div id="modelContent" style="height: 100%; width: 100%"></div>
    </div>

    <!-- Load components and utilities -->
    <script src="./js/components.js"></script>
    <script src="./js/charts.js"></script>
    <script src="./js/3dmodel.js"></script>
    <script src="./js/ui-components.js"></script>
    
    <script>
        // Test prompts with varied phoneme coverage
        const prompts = [
            "The red robin ran rapidly around the rocky river.",
            "She sells seashells by the seashore as the sun shines.",
            "Three thrilling thieves thought thoroughly through their theft.",
            "Lucy likes light lilac flowers along the lively lake.",
            "Can you carefully carry the colorful cards to the corner?"
        ];
        
        let currentPromptIndex = 0;
        let results = [];
        let mouthModel;
        let mouthModelVisible = false;
        let problemPhonemes = [];
        
        // Media recorder variables
        let mediaRecorder;
        let audioChunks = [];
        let audioUrl;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI
            const startTestBtn = document.getElementById('startTestBtn');
            const recordButton = document.getElementById('recordButton');
            const playButton = document.getElementById('playButton');
            const nextButton = document.getElementById('nextButton');
            const promptDisplay = document.getElementById('promptDisplay');
            const status = document.getElementById('status');
            const audioPlayback = document.getElementById('audioPlayback');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // Initialize 3D model
            mouthModel = new FluentForm.MouthModel('modelContent');
            
            // Set initial prompt
            promptDisplay.textContent = prompts[currentPromptIndex];
            
            // Start test button
            startTestBtn.addEventListener('click', () => {
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('testInterface').style.display = 'block';
                promptDisplay.textContent = prompts[currentPromptIndex];
                updateProgress();
            });
            
            // Close model button
            document.getElementById('closeModelBtn').addEventListener('click', () => {
                document.getElementById('mouthModelContainer').style.display = 'none';
                mouthModelVisible = false;
            });
            
            // Record button
            recordButton.addEventListener('click', async () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recordButton.innerHTML = '<i class="bi bi-record-circle btn-icon"></i> Start Recording';
                    recordButton.classList.remove('btn-error');
                    recordButton.classList.add('btn-accent');
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                channelCount: 1,
                                sampleRate: 16000
                            }
                        });
                        
                        audioChunks = [];
                        
                        mediaRecorder = new MediaRecorder(stream, {
                            mimeType: 'audio/webm'
                        });
                        
                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };
                        
                        mediaRecorder.onstop = () => {
                            // Create the WebM blob
                            const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            
                            // Create URL for playback
                            if (audioUrl) {
                                URL.revokeObjectURL(audioUrl);
                            }
                            audioUrl = URL.createObjectURL(webmBlob);
                            
                            // Set up audio playback
                            audioPlayback.src = audioUrl;
                            audioPlayback.style.display = 'block';
                            playButton.disabled = false;
                            
                            // Convert WebM to WAV and analyze
                            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            const fileReader = new FileReader();
                            
                            fileReader.onloadend = () => {
                                const arrayBuffer = fileReader.result;
                                audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
                                    // Convert to WAV
                                    const wavBuffer = audioBufferToWav(audioBuffer);
                                    const wavBlob = new Blob([wavBuffer], { type: 'audio/wav' });
                                    
                                    // Show loading state
                                    document.getElementById('transcription').innerHTML = 
                                        '<div class="loading"><i class="bi bi-arrow-repeat"></i> Processing your speech...</div>';
                                    document.getElementById('analysis').innerHTML = 
                                        '<div class="loading"><i class="bi bi-arrow-repeat"></i> Analyzing your pronunciation...</div>';
                                    
                                    // Send to server with reference text
                                    const formData = new FormData();
                                    formData.append('audio', wavBlob, 'recording.wav');
                                    formData.append('referenceText', prompts[currentPromptIndex]);
                                    
                                    fetch('http://127.0.0.1:3000/api/analyze-speech', {
                                        method: 'POST',
                                        body: formData
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Analysis data:', data);
                                        
                                        // Store results for this prompt
                                        results.push(data);
                                        
                                        // Update the UI with the results
                                        FluentForm.UI.createVisualTranscription('transcription', data.transcription, data.phonemes);
                                        FluentForm.UI.initVisualTranscriptionInteractions();
                                        
                                        // Create phoneme analysis display
                                        const phonemeGridHtml = FluentForm.UI.createPhonemeGrid(data.phonemes);
                                        document.getElementById('analysis').innerHTML = phonemeGridHtml;
                                        
                                        // Find problem phonemes
                                        const currentProblemPhonemes = data.phonemes
                                            .filter(p => p.accuracyScore < 70)
                                            .map(p => p.phoneme);
                                            
                                        problemPhonemes = [...new Set([...problemPhonemes, ...currentProblemPhonemes])];
                                        
                                        // Enable next button
                                        nextButton.disabled = false;
                                        
                                        status.textContent = 'Analysis complete';
                                    })
                                    .catch(error => {
                                        console.error('Analysis error:', error);
                                        document.getElementById('transcription').innerHTML = `
                                            <div class="error-state">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <p>There was an error processing your speech.</p>
                                                <p>Please try again later or contact support.</p>
                                            </div>
                                        `;
                                        document.getElementById('analysis').innerHTML = `
                                            <div class="error-state">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <p>Error: ${error.message}</p>
                                            </div>
                                        `;
                                        status.textContent = 'Error: ' + error.message;
                                    });
                                });
                            };
                            
                            fileReader.readAsArrayBuffer(webmBlob);
                        };
                        
                        mediaRecorder.start(100);
                        recordButton.innerHTML = '<i class="bi bi-stop-fill btn-icon"></i> Stop Recording';
                        recordButton.classList.remove('btn-accent');
                        recordButton.classList.add('btn-error');
                        status.textContent = 'Recording...';
                        
                    } catch (error) {
                        console.error('Recording error:', error);
                        status.textContent = 'Error: ' + error.message;
                    }
                }
            });
            
            // Play button
            playButton.onclick = () => {
                if (audioPlayback.paused) {
                    audioPlayback.play();
                    playButton.innerHTML = '<i class="bi bi-pause-fill btn-icon"></i> Pause';
                } else {
                    audioPlayback.pause();
                    playButton.innerHTML = '<i class="bi bi-play-fill btn-icon"></i> Play Recording';
                }
            };
            
            audioPlayback.onended = () => {
                playButton.innerHTML = '<i class="bi bi-play-fill btn-icon"></i> Play Recording';
            };
            
            // Next button
            nextButton.addEventListener('click', () => {
                currentPromptIndex++;
                
                if (currentPromptIndex < prompts.length) {
                    // Move to next prompt
                    promptDisplay.textContent = prompts[currentPromptIndex];
                    updateProgress();
                    
                    // Reset UI for next recording
                    resetRecordingUI();
                } else {
                    // Test complete, show results
                    showResults();
                }
            });
            
            // Helper function to update progress
            function updateProgress() {
                const progress = ((currentPromptIndex) / prompts.length) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Prompt ${currentPromptIndex + 1} of ${prompts.length}`;
            }
            
            // Helper function to reset UI for next prompt
            function resetRecordingUI() {
                document.getElementById('transcription').innerHTML = 'Transcription will appear here...';
                document.getElementById('analysis').innerHTML = 'Analysis will appear here...';
                audioPlayback.style.display = 'none';
                playButton.disabled = true;
                nextButton.disabled = true;
                status.textContent = 'Click to start recording';
            }
            
            // Helper function to show final results
            function showResults() {
                document.getElementById('testInterface').style.display = 'none';
                document.getElementById('resultsSummary').style.display = 'block';
                
                // Calculate overall score
                const allPhonemeScores = results.flatMap(r => r.phonemes.map(p => p.accuracyScore));
                const overallScore = Math.round(allPhonemeScores.reduce((sum, score) => sum + score, 0) / allPhonemeScores.length);
                
                // Update overall score display
                document.getElementById('overallScore').textContent = overallScore;
                
                // Style the score circle based on the score
                const scoreCircle = document.querySelector('.score-circle');
                if (overallScore >= 90) {
                    scoreCircle.classList.add('excellent');
                } else if (overallScore >= 75) {
                    scoreCircle.classList.add('good');
                } else if (overallScore >= 60) {
                    scoreCircle.classList.add('average');
                } else {
                    scoreCircle.classList.add('needs-work');
                }
                
                // Aggregate all phonemes across all prompts
                const allPhonemes = results.flatMap(r => r.phonemes);
                
                // Group by phoneme and calculate average score
                const phonemeMap = new Map();
                allPhonemes.forEach(p => {
                    if (!phonemeMap.has(p.phoneme)) {
                        phonemeMap.set(p.phoneme, { 
                            phoneme: p.phoneme, 
                            scores: [], 
                            words: new Set() 
                        });
                    }
                    phonemeMap.get(p.phoneme).scores.push(p.accuracyScore);
                    phonemeMap.get(p.phoneme).words.add(p.fromWord);
                });
                
                // Convert to array and calculate averages
                const phonemeAverages = Array.from(phonemeMap.values()).map(p => ({
                    phoneme: p.phoneme,
                    accuracyScore: Math.round(p.scores.reduce((sum, score) => sum + score, 0) / p.scores.length),
                    exampleWord: Array.from(p.words)[0] || ''
                }));
                
                // Sort by score (lowest first)
                phonemeAverages.sort((a, b) => a.accuracyScore - b.accuracyScore);
                
                // Populate phoneme grid
                const phonemeGrid = document.getElementById('phonemeGrid');
                phonemeGrid.innerHTML = '';
                
                phonemeAverages.forEach(p => {
                    const card = FluentForm.createPhonemeCard(p.phoneme, p.accuracyScore, p.exampleWord);
                    phonemeGrid.appendChild(card);
                });
                
                // Create focus areas section
                const focusAreas = document.getElementById('focusAreas');
                focusAreas.innerHTML = '';
                
                // Get the 3-5 lowest scoring phonemes
                const lowestPhonemes = phonemeAverages.slice(0, Math.min(5, phonemeAverages.length)).filter(p => p.accuracyScore < 75);
                
                if (lowestPhonemes.length > 0) {
                    // Save problem sounds to local storage
                    localStorage.setItem('problemSounds', JSON.stringify(
                        lowestPhonemes.map(p => ({ phoneme: p.phoneme, score: p.accuracyScore }))
                    ));
                    
                    const focusPhonemesList = document.createElement('ul');
                    focusPhonemesList.className = 'focus-phonemes-list';
                    
                    lowestPhonemes.forEach(p => {
                        const item = document.createElement('li');
                        item.className = 'focus-phoneme-item';
                        item.innerHTML = `
                            <div class="focus-phoneme">
                                <span class="phoneme-symbol">${p.phoneme}</span>
                                <div class="focus-phoneme-details">
                                    <span class="phoneme-score ${getScoreClass(p.accuracyScore)}">${p.accuracyScore}%</span>
                                    <span class="phoneme-word">Example: "${p.exampleWord}"</span>
                                </div>
                                <button class="btn btn-small btn-secondary show-model-btn" data-phoneme="${p.phoneme}">
                                    <i class="bi bi-box"></i> Show Position
                                </button>
                            </div>
                        `;
                        focusPhonemesList.appendChild(item);
                    });
                    
                    focusAreas.appendChild(focusPhonemesList);
                    
                    // Add event listeners for show model buttons
                    document.querySelectorAll('.show-model-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const phoneme = btn.getAttribute('data-phoneme');
                            document.getElementById('mouthModelContainer').style.display = 'flex';
                            mouthModelVisible = true;
                            mouthModel.showPhonemePosition(phoneme);
                        });
                    });
                    
                    // Generate recommendations text
                    const recommendationsText = document.getElementById('recommendationsText');
                    recommendationsText.innerHTML = `
                        Based on your assessment, we recommend focusing on the 
                        ${lowestPhonemes.length === 1 ? 'phoneme' : 'phonemes'} 
                        ${lowestPhonemes.map(p => `<strong>${p.phoneme}</strong>`).join(', ')}. 
                        Regular practice with our targeted exercises will help improve your pronunciation.
                    `;
                    
                    // Create exercise recommendations
                    const exerciseRecommendations = document.getElementById('exerciseRecommendations');
                    exerciseRecommendations.innerHTML = '';
                    
                    // Just create 3 sample exercise recommendations for the lowest scoring phonemes
                    for (let i = 0; i < Math.min(3, lowestPhonemes.length); i++) {
                        const phoneme = lowestPhonemes[i].phoneme;
                        const difficulty = i === 0 ? 'Beginner' : (i === 1 ? 'Intermediate' : 'Advanced');
                        
                        let exerciseTitle, exerciseDescription;
                        
                        if (phoneme === 'r') {
                            exerciseTitle = 'R Sound Practice';
                            exerciseDescription = 'Focus on proper tongue placement for clear R sounds.';
                        } else if (phoneme === 'th') {
                            exerciseTitle = 'TH Sound Practice';
                            exerciseDescription = 'Learn the correct tongue position between your teeth.';
                        } else if (phoneme === 's') {
                            exerciseTitle = 'S Sound Clarity';
                            exerciseDescription = 'Reduce lisping with targeted S sound exercises.';
                        } else {
                            exerciseTitle = `${phoneme.toUpperCase()} Sound Practice`;
                            exerciseDescription = `Improve your ${phoneme} pronunciation with targeted exercises.`;
                        }
                        
                        const card = FluentForm.createExerciseCard(
                            exerciseTitle, 
                            exerciseDescription, 
                            phoneme, 
                            difficulty
                        );
                        exerciseRecommendations.appendChild(card);
                    }
                    
                } else {
                    focusAreas.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-emoji-smile"></i>
                            <p>Great job! You don't have any significant problem areas.</p>
                            <p>You can still practice to further improve your pronunciation.</p>
                        </div>
                    `;
                    
                    document.getElementById('recommendationsText').textContent = 
                        "Excellent work! Your pronunciation is already quite good. Continue practicing to maintain your skills.";
                }
            }
            
            // Helper function to get score class for styling
            function getScoreClass(score) {
                if (score >= 90) return 'excellent';
                if (score >= 75) return 'good';
                if (score >= 60) return 'average';
                if (score >= 40) return 'needs-work';
                return 'poor';
            }
        });
        
        // Helper function to convert AudioBuffer to WAV format
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const wav = new ArrayBuffer(44 + buffer.length * bytesPerSample);
            const view = new DataView(wav);
            
            // Write WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + buffer.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, buffer.length * bytesPerSample, true);
            
            // Write audio data
            const offset = 44;
            const data = new Float32Array(buffer.length);
            buffer.copyFromChannel(data, 0);
            
            for (let i = 0; i < data.length; i++) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset + i * bytesPerSample, sample * 0x7FFF, true);
            }
            
            return wav;
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
    </script>
    
    <style>
        /* Additional styles specific to proficiency test */
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--info-color-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
            color: var(--neutral-dark);
            transition: all var(--transition-normal) var(--transition-timing-ease);
        }
        
        .score-circle #overallScore {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .score-circle .percent {
            font-size: 1rem;
            font-weight: 500;
        }
        
        .score-circle.excellent {
            background-color: var(--success-color-light);
            color: var(--success-color);
        }
        
        .score-circle.good {
            background-color: #d0f0f0;
            color: var(--score-good);
        }
        
        .score-circle.average {
            background-color: #ffefd0;
            color: var(--score-average);
        }
        
        .score-circle.needs-work {
            background-color: var(--warning-color-light);
            color: var(--warning-color);
        }
        
        .overall-score-container {
            text-align: center;
            margin-bottom: var(--space-xl);
        }
        
        .score-label {
            font-size: var(--font-size-lg);
            font-weight: 500;
            margin-top: var(--space-xs);
        }
        
        .summary-card {
            background-color: var(--neutral-white);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            margin-top: var(--space-lg);
        }
        
        .summary-header {
            padding: var(--space-lg);
            background-color: var(--fluent-primary);
            color: var(--neutral-white);
        }
        
        .summary-header h4 {
            margin: 0;
            color: var(--neutral-white);
        }
        
        .summary-content {
            padding: var(--space-lg);
        }
        
        .summary-footer {
            padding: var(--space-lg);
            border-top: 1px solid var(--background-light);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
        }
        
        .focus-phonemes-list {
            list-style: none;
            padding: 0;
            margin: var(--space-md) 0;
        }
        
        .focus-phoneme-item {
            margin-bottom: var(--space-md);
        }
        
        .focus-phoneme {
            display: flex;
            align-items: center;
            background-color: var(--background-light);
            border-radius: var(--border-radius-medium);
            padding: var(--space-md);
        }
        
        .focus-phoneme .phoneme-symbol {
            font-size: 1.5rem;
            font-weight: 700;
            background-color: var(--fluent-primary-light);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-md);
        }
        
        .focus-phoneme-details {
            flex: 1;
        }
        
        .focus-phoneme .phoneme-score {
            font-weight: 600;
            font-size: var(--font-size-lg);
            display: block;
        }
        
        .focus-phoneme .phoneme-word {
            font-size: var(--font-size-sm);
            color: var(--neutral-light);
        }
        
        .show-model-btn {
            margin-left: auto;
        }
        
        .model-container-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .close-model-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--neutral-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            z-index: 1001;
        }
        
        .progress-indicator {
            margin-bottom: var(--space-lg);
        }
        
        .progress-label {
            font-weight: 500;
            margin-bottom: var(--space-xs);
        }
        
        #progressText {
            font-size: var(--font-size-sm);
            color: var(--neutral-light);
            margin-top: var(--space-xs);
        }
        
        .recommended-exercises {
            margin-top: var(--space-lg);
        }
        
        .recommendations-container {
            margin-top: var(--space-xl);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-xl) var(--space-lg);
            color: var(--neutral-light);
        }
        
        .empty-state i {
            font-size: 2rem;
            margin-bottom: var(--space-md);
            color: var(--fluent-primary);
        }
        
        .error-state {
            color: var(--error-color);
            text-align: center;
            padding: var(--space-lg);
        }
        
        .error-state i {
            font-size: 2rem;
            margin-bottom: var(--space-md);
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-lg);
            color: var(--neutral-light);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: var(--space-md);
            animation: spin 1.5s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
